<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogKitchen - Synthetic Log Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Kitchen-inspired Light Theme (whites and reds) */
            --bg-gradient-start: #dc2626;
            --bg-gradient-end: #b91c1c;
            --container-bg: #ffffff;
            --header-bg: #1f2937;
            --header-text: #ffffff;
            --header-subtitle: #9ca3af;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --form-bg: #fef2f2;
            --input-border: #fecaca;
            --input-focus: #dc2626;
            --button-primary-bg: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            --button-primary-hover: #991b1b;
            --button-secondary-bg: #dc2626;
            --button-secondary-hover: #b91c1c;
            --log-display-bg: #1f2937;
            --log-display-text: #e5e7eb;
            --alert-success-bg: #dcfce7;
            --alert-success-text: #166534;
            --alert-success-border: #86efac;
            --alert-error-bg: #fee2e2;
            --alert-error-text: #991b1b;
            --alert-error-border: #fca5a5;
            --banner-bg: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            --banner-link-bg: rgba(255, 255, 255, 0.2);
            --banner-link-hover: rgba(255, 255, 255, 0.3);
            --footer-bg: #f9fafb;
            --footer-text: #6b7280;
            --footer-border: #e5e7e8;
        }

        [data-theme="dark"] {
            --bg-gradient-start: #1f2937;
            --bg-gradient-end: #111827;
            --container-bg: #1f2937;
            --header-bg: #111827;
            --header-text: #f3f4f6;
            --header-subtitle: #9ca3af;
            --text-primary: #f3f4f6;
            --text-secondary: #d1d5db;
            --form-bg: #374151;
            --input-border: #4b5563;
            --input-focus: #ef4444;
            --button-primary-bg: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --button-primary-hover: #b91c1c;
            --button-secondary-bg: #ef4444;
            --button-secondary-hover: #dc2626;
            --log-display-bg: #111827;
            --log-display-text: #e5e7eb;
            --alert-success-bg: #064e3b;
            --alert-success-text: #d1fae5;
            --alert-success-border: #10b981;
            --alert-error-bg: #7f1d1d;
            --alert-error-text: #fecaca;
            --alert-error-border: #ef4444;
            --banner-bg: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
            --banner-link-bg: rgba(255, 255, 255, 0.1);
            --banner-link-hover: rgba(255, 255, 255, 0.2);
            --footer-bg: #111827;
            --footer-text: #9ca3af;
            --footer-border: #374151;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            transition: background 0.3s ease;
        }

        header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 30px;
            text-align: center;
            position: relative;
            transition: background 0.3s ease;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            color: var(--header-subtitle);
            font-size: 1.1em;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: var(--header-text);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .content {
            padding: 40px;
            transition: all 0.3s ease;
        }

        .form-section {
            background: var(--form-bg);
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            transition: background 0.3s ease;
        }

        .form-section h2 {
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--input-border);
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s;
            background: var(--container-bg);
            color: var(--text-primary);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--input-focus);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        button {
            flex: 1;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--button-primary-bg);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--button-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.4);
        }

        .btn-primary:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            opacity: 0.5;
        }

        .btn-secondary {
            background: var(--button-secondary-bg);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--button-secondary-hover);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.4);
        }

        .btn-secondary:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            opacity: 0.5;
        }

        .output-section {
            margin-top: 30px;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .output-header h2 {
            color: var(--text-primary);
        }

        .output-info {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .log-display {
            background: var(--log-display-bg);
            color: var(--log-display-text);
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            transition: all 0.3s ease;
        }

        .log-display:empty::before {
            content: 'Generated logs will appear here...';
            color: var(--text-secondary);
            font-style: italic;
        }

        .spinner {
            display: none;
            border: 4px solid var(--input-border);
            border-top: 4px solid var(--button-secondary-bg);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner.active {
            display: block;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
            white-space: pre-line;
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .alert.error {
            background: var(--alert-error-bg);
            color: var(--alert-error-text);
            border: 1px solid var(--alert-error-border);
        }

        .alert.success {
            background: var(--alert-success-bg);
            color: var(--alert-success-text);
            border: 1px solid var(--alert-success-border);
        }

        .alert.active {
            display: block;
        }

        .help-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        footer {
            background: var(--footer-bg);
            padding: 20px;
            text-align: center;
            color: var(--footer-text);
            border-top: 1px solid var(--footer-border);
            transition: all 0.3s ease;
        }

        .info-banner {
            background: var(--banner-bg);
            color: white;
            padding: 20px 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
            transition: all 0.3s ease;
        }

        .info-banner h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .info-banner p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .info-banner .links {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .info-banner .link-item {
            background: var(--banner-link-bg);
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            color: white;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-block;
        }

        .info-banner .link-item:hover {
            background: var(--banner-link-hover);
            transform: translateY(-2px);
        }

        .integration-steps {
            background: var(--banner-link-bg);
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .integration-steps ol {
            margin: 10px 0 0 20px;
            line-height: 1.8;
        }

        .integration-steps a {
            color: white;
            text-decoration: underline;
        }

        .integration-steps code {
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
                🌙 Dark Mode
            </button>
            <h1>🍳 LogKitchen</h1>
            <p>Synthetic Log Generator for SIEM Testing</p>
        </header>

        <div class="content">
            <div class="alert" id="alert"></div>

            <div class="info-banner">
                <h3>🔍 Integrated with Azure Data Explorer (Kusto)</h3>
                <p>This LogKitchen instance is running alongside Kustainer - a local Azure Data Explorer for analyzing your generated logs with KQL (Kusto Query Language).</p>

                <div class="links">
                    <div class="link-item" id="kustoStatus" style="cursor: default;">
                        <span id="kustoStatusIcon">🔄</span> Kusto Status: <span id="kustoStatusText">Checking...</span>
                    </div>
                    <a href="https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/" target="_blank" class="link-item">📚 KQL Documentation</a>
                </div>

                <div class="integration-steps">
                    <strong>🚀 Quick Start Guide (Persistent Database):</strong>
                    <ol>
                        <li><strong>Generate logs:</strong> Use the form below to create synthetic logs</li>
                        <li><strong>Download logs:</strong> Save them to the <code>outputs/</code> folder (automatically shared with Kustainer)</li>
                        <li><strong>Connect to Kusto:</strong> Use Kusto Explorer or Kusto CLI (Windows apps) to connect to <code>http://localhost:8080</code></li>
                        <li><strong>Create persistent database:</strong>
                            <br><code>.create database LogAnalysis persist (@"/kustodata/dbs/LogAnalysis/md", @"/kustodata/dbs/LogAnalysis/data")</code>
                        </li>
                        <li><strong>Create a table:</strong>
                            <br><code>.create table Logs (Timestamp:datetime, Level:string, Message:string, Host:string)</code>
                        </li>
                        <li><strong>Ingest from shared folder:</strong>
                            <br><code>.ingest into table Logs (@"/logs/yourfile.log") with (format="csv", ignoreFirstRecord=false)</code>
                        </li>
                        <li><strong>Query:</strong> <code>Logs | take 10</code> or <code>Logs | summarize count() by Level</code></li>
                    </ol>
                    <p style="margin-top: 10px; font-size: 0.9em;">
                        💾 <strong>Note:</strong> Databases created with <code>persist</code> survive container restarts via the <code>kustodata/</code> folder!
                    </p>
                </div>
            </div>

            <div class="form-section">
                <h2 style="margin-bottom: 20px; color: #2d3748;">Generate Logs</h2>

                <div class="form-group">
                    <label for="log_type">Log Type</label>
                    <select id="log_type">
                        {% for key, name in log_types.items() %}
                        <option value="{{ key }}">{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="count">Number of Logs</label>
                    <input type="number" id="count" min="1" max="10000" value="100">
                    <p class="help-text">Generate between 1 and 10,000 log entries</p>
                </div>

                <div class="form-group">
                    <label for="seed">Random Seed (Optional)</label>
                    <input type="text" id="seed" placeholder="Leave empty for random output">
                    <p class="help-text">Use a seed value for reproducible log generation</p>
                </div>

                <div class="button-group">
                    <button class="btn-primary" id="generateBtn" onclick="generateLogs()">
                        Generate Logs
                    </button>
                    <button class="btn-secondary" id="saveToOutputsBtn" onclick="saveToOutputs()" disabled style="flex: 1.5;">
                        💾 Save to Outputs Folder (for Kusto)
                    </button>
                    <button class="btn-secondary" id="downloadBtn" onclick="downloadLogs()" disabled>
                        Download to Browser
                    </button>
                </div>
            </div>

            <div class="spinner" id="spinner"></div>

            <div class="output-section" id="outputSection" style="display: none;">
                <div class="output-header">
                    <h2>Generated Logs</h2>
                    <span class="output-info" id="outputInfo"></span>
                </div>
                <div class="log-display" id="logDisplay"></div>
            </div>
        </div>

        <footer>
            <p>LogKitchen - Dockerized Web Interface</p>
            <p style="margin-top: 5px; font-size: 12px;">Generate synthetic logs for testing SIEM systems and detection rules</p>
        </footer>
    </div>

    <script>
        let currentLogs = [];
        let currentLogType = '';

        function showAlert(message, type = 'error') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type} active`;
            setTimeout(() => {
                alert.classList.remove('active');
            }, 5000);
        }

        async function generateLogs() {
            const logType = document.getElementById('log_type').value;
            const count = parseInt(document.getElementById('count').value);
            const seed = document.getElementById('seed').value;

            // Validation
            if (count < 1 || count > 10000) {
                showAlert('Count must be between 1 and 10,000');
                return;
            }

            // UI updates
            const generateBtn = document.getElementById('generateBtn');
            const spinner = document.getElementById('spinner');
            generateBtn.disabled = true;
            spinner.classList.add('active');
            document.getElementById('logDisplay').textContent = '';

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        log_type: logType,
                        count: count,
                        seed: seed || null
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to generate logs');
                }

                // Store logs for download
                currentLogs = data.logs;
                currentLogType = data.log_type;

                // Display logs
                const logDisplay = document.getElementById('logDisplay');
                logDisplay.textContent = data.logs.join('\n');

                // Update info
                document.getElementById('outputInfo').textContent =
                    `${data.count} ${data.log_type_name} entries generated`;
                document.getElementById('outputSection').style.display = 'block';
                document.getElementById('downloadBtn').disabled = false;
                document.getElementById('saveToOutputsBtn').disabled = false;

                showAlert('Logs generated successfully!', 'success');

            } catch (error) {
                showAlert(error.message);
            } finally {
                generateBtn.disabled = false;
                spinner.classList.remove('active');
            }
        }

        async function saveToOutputs() {
            if (currentLogs.length === 0) {
                showAlert('No logs to save');
                return;
            }

            try {
                const response = await fetch('/save_to_outputs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        logs: currentLogs,
                        log_type: currentLogType
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to save logs');
                }

                showAlert(
                    `✅ ${data.message}\n\n` +
                    `📁 File: ${data.filename}\n` +
                    `🔍 Kusto path: ${data.kusto_path}\n\n` +
                    `Ready to ingest into Kustainer!`,
                    'success'
                );

            } catch (error) {
                showAlert(error.message);
            }
        }

        async function downloadLogs() {
            if (currentLogs.length === 0) {
                showAlert('No logs to download');
                return;
            }

            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        logs: currentLogs,
                        log_type: currentLogType
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to download logs');
                }

                // Create download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `logkitchen_${currentLogType}_${Date.now()}.log`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showAlert('Logs downloaded to browser successfully!', 'success');

            } catch (error) {
                showAlert(error.message);
            }
        }

        // Allow Enter key to generate logs
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                generateLogs();
            }
        });

        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            const themeToggle = document.getElementById('themeToggle');
            if (newTheme === 'dark') {
                themeToggle.textContent = '☀️ Light Mode';
            } else {
                themeToggle.textContent = '🌙 Dark Mode';
            }
        }

        // Load saved theme on page load
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;
            html.setAttribute('data-theme', savedTheme);

            const themeToggle = document.getElementById('themeToggle');
            if (savedTheme === 'dark') {
                themeToggle.textContent = '☀️ Light Mode';
            } else {
                themeToggle.textContent = '🌙 Dark Mode';
            }
        })();

        // Kusto status checker
        async function checkKustoStatus() {
            const statusIcon = document.getElementById('kustoStatusIcon');
            const statusText = document.getElementById('kustoStatusText');

            try {
                const response = await fetch('/kusto_status');
                const data = await response.json();

                if (data.status === 'online') {
                    statusIcon.textContent = '✅';
                    statusText.textContent = 'Online';
                    statusText.title = data.message;
                } else if (data.status === 'offline') {
                    statusIcon.textContent = '❌';
                    statusText.textContent = 'Offline';
                    statusText.title = data.message;
                } else if (data.status === 'timeout') {
                    statusIcon.textContent = '⏱️';
                    statusText.textContent = 'Timeout';
                    statusText.title = data.message;
                } else {
                    statusIcon.textContent = '⚠️';
                    statusText.textContent = 'Error';
                    statusText.title = data.message;
                }
            } catch (error) {
                statusIcon.textContent = '❌';
                statusText.textContent = 'Check Failed';
                statusText.title = 'Could not check Kusto status';
            }
        }

        // Check status on page load
        checkKustoStatus();

        // Check status every 30 seconds
        setInterval(checkKustoStatus, 30000);
    </script>
</body>
</html>
